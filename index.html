<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apartment Society Maintenance Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
        }

        .nav-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            background: transparent;
            font-size: 16px;
            font-weight: 500;
            color: #666;
        }

        .nav-tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .nav-tab:hover {
            background: #fff;
        }

        .content {
            padding: 30px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .setup-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .setup-section h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .status-paid {
            color: #28a745;
            font-weight: 600;
        }

        .status-pending {
            color: #dc3545;
            font-weight: 600;
        }

        .status-partial {
            color: #ffc107;
            font-weight: 600;
        }

        .alert {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .alert-info {
            background: #d1ecf1;
            border-left: 4px solid #0c5460;
            color: #0c5460;
        }

        .alert-warning {
            background: #fff3cd;
            border-left: 4px solid #856404;
            color: #856404;
        }

        .alert-success {
            background: #d4edda;
            border-left: 4px solid #155724;
            color: #155724;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-card h4 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 28px;
            font-weight: 700;
        }

        .member-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .member-card h4 {
            color: #333;
            margin-bottom: 10px;
        }

        .payment-record {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            margin-top: 10px;
        }

        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 13px;
        }

        .instructions {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .instructions ol {
            margin-left: 20px;
        }

        .instructions li {
            margin-bottom: 10px;
            line-height: 1.6;
        }

        @media (max-width: 768px) {
            .grid-2, .grid-3 {
                grid-template-columns: 1fr;
            }

            .nav-tab {
                font-size: 14px;
                padding: 12px 8px;
            }

            .content {
                padding: 15px;
            }
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè¢ Apartment Society Maintenance Tracker</h1>
            <p>Transparent management for 53 houses</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('setup')">‚öôÔ∏è Setup</button>
            <button class="nav-tab" onclick="switchTab('admin')">üë®‚Äçüíº Admin Panel</button>
            <button class="nav-tab" onclick="switchTab('members')">üë• Member View</button>
            <button class="nav-tab" onclick="switchTab('reports')">üìä Reports</button>
        </div>

        <div class="content">
            <!-- Setup Tab -->
            <div id="setup" class="tab-content active">
                <div class="alert alert-info">
                    <strong>Welcome!</strong> Follow these steps to set up your apartment maintenance tracking system.
                </div>

                <div class="setup-section">
                    <h3>üìã Step 1: Create Google Sheet</h3>
                    <div class="instructions">
                        <ol>
                            <li>Go to <a href="https://sheets.google.com" target="_blank">Google Sheets</a> and create a new spreadsheet</li>
                            <li>Name it "Apartment Maintenance Tracker"</li>
                            <li>Create the following sheets (tabs):
                                <ul>
                                    <li><strong>Members</strong> - List of all 53 houses</li>
                                    <li><strong>MonthlyCharges</strong> - Fixed and variable charges</li>
                                    <li><strong>Payments</strong> - Payment records</li>
                                    <li><strong>Config</strong> - Configuration settings</li>
                                </ul>
                            </li>
                        </ol>
                    </div>
                </div>

                <div class="setup-section">
                    <h3>üîó Step 2: Set up Google Sheets API</h3>
                    <div class="instructions">
                        <ol>
                            <li>Go to <a href="https://console.cloud.google.com" target="_blank">Google Cloud Console</a></li>
                            <li>Create a new project or select existing one</li>
                            <li>Enable Google Sheets API</li>
                            <li>Create credentials (API Key)</li>
                            <li>Make your sheet publicly accessible:
                                <ul>
                                    <li>Click "Share" ‚Üí Change to "Anyone with the link can view"</li>
                                </ul>
                            </li>
                            <li>Copy your Spreadsheet ID from the URL:<br>
                                <code>https://docs.google.com/spreadsheets/d/<strong>[SPREADSHEET_ID]</strong>/edit</code>
                            </li>
                        </ol>
                    </div>

                    <div class="form-group">
                        <label>Google Sheets API Key:</label>
                        <input type="text" id="apiKey" placeholder="Enter your API key">
                    </div>

                    <div class="form-group">
                        <label>Spreadsheet ID:</label>
                        <input type="text" id="spreadsheetId" placeholder="Enter your spreadsheet ID">
                    </div>

                    <button class="btn btn-primary" onclick="saveConfig()">üíæ Save Configuration</button>
                </div>

                <div class="setup-section">
                    <h3>üè† Step 3: Initialize Member Data</h3>
                    <p>This will create 53 house records in your Google Sheet</p>
                    
                    <div class="form-group">
                        <label>Number of Occupied Houses:</label>
                        <input type="number" id="occupiedHouses" value="12" min="0" max="53">
                    </div>

                    <div class="form-group">
                        <label>Number of Interior Ongoing Houses:</label>
                        <input type="number" id="interiorHouses" value="0" min="0" max="53">
                    </div>

                    <button class="btn btn-success" onclick="initializeMembers()">üöÄ Initialize Members</button>
                </div>

                <div class="setup-section">
                    <h3>üí∞ Step 4: Set Monthly Charges</h3>
                    <div class="grid-2">
                        <div class="form-group">
                            <label>Meter Charges (Kaveri):</label>
                            <input type="number" id="meterCharges" value="500">
                        </div>
                        <div class="form-group">
                            <label>Sanitary Charges (Kaveri):</label>
                            <input type="number" id="sanitaryCharges" value="8000">
                        </div>
                        <div class="form-group">
                            <label>Other Charges (Kaveri):</label>
                            <input type="number" id="otherCharges" value="11000">
                        </div>
                        <div class="form-group">
                            <label>SC Borewell (Kaveri):</label>
                            <input type="number" id="borewellCharges" value="10000">
                        </div>
                        <div class="form-group">
                            <label>Security Salary:</label>
                            <input type="number" id="securitySalary" value="12000">
                        </div>
                        <div class="form-group">
                            <label>Common Power:</label>
                            <input type="number" id="commonPower" value="0">
                        </div>
                        <div class="form-group">
                            <label>Water Charges (for occupied/interior):</label>
                            <input type="number" id="waterCharges" value="2000">
                        </div>
                        <div class="form-group">
                            <label>Diesel (Approx):</label>
                            <input type="number" id="dieselCharges" value="10000">
                        </div>
                    </div>

                    <button class="btn btn-primary" onclick="saveMonthlyCharges()">üíæ Save Monthly Charges</button>
                </div>
            </div>

            <!-- Admin Panel Tab -->
            <div id="admin" class="tab-content">
                <div class="alert alert-warning">
                    <strong>Admin Access:</strong> This panel allows you to manage all aspects of the maintenance system.
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <h4>Total Houses</h4>
                        <div class="value" id="totalHouses">53</div>
                    </div>
                    <div class="stat-card">
                        <h4>Total Collected</h4>
                        <div class="value" id="totalCollected">‚Çπ0</div>
                    </div>
                    <div class="stat-card">
                        <h4>Total Pending</h4>
                        <div class="value" id="totalPending">‚Çπ0</div>
                    </div>
                    <div class="stat-card">
                        <h4>Collection Rate</h4>
                        <div class="value" id="collectionRate">0%</div>
                    </div>
                </div>

                <div class="setup-section">
                    <h3>üí≥ Record Payment</h3>
                    <div class="grid-3">
                        <div class="form-group">
                            <label>House Number:</label>
                            <select id="paymentHouse">
                                <option value="">Select House</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Amount Paid:</label>
                            <input type="number" id="paymentAmount" placeholder="Enter amount">
                        </div>
                        <div class="form-group">
                            <label>Payment Date:</label>
                            <input type="date" id="paymentDate">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Payment Mode:</label>
                        <select id="paymentMode">
                            <option value="Cash">Cash</option>
                            <option value="Online Transfer">Online Transfer</option>
                            <option value="Cheque">Cheque</option>
                            <option value="UPI">UPI</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Notes (Optional):</label>
                        <input type="text" id="paymentNotes" placeholder="e.g., Month of January 2025">
                    </div>
                    <button class="btn btn-success" onclick="recordPayment()">‚úÖ Record Payment</button>
                </div>

                <div class="setup-section">
                    <h3>üìã All Members</h3>
                    <button class="btn btn-primary" onclick="loadAllMembers()">üîÑ Refresh Data</button>
                    <button class="btn btn-secondary" onclick="exportToExcel()">üì• Export to Excel</button>
                    
                    <div class="table-container">
                        <table id="adminMembersTable">
                            <thead>
                                <tr>
                                    <th>House #</th>
                                    <th>Owner Name</th>
                                    <th>Status</th>
                                    <th>Monthly Due</th>
                                    <th>Total Paid</th>
                                    <th>Balance</th>
                                    <th>Payment Status</th>
                                </tr>
                            </thead>
                            <tbody id="adminMembersBody">
                                <tr>
                                    <td colspan="7" class="loading">
                                        <div class="spinner"></div>
                                        Loading data...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Members View Tab -->
            <div id="members" class="tab-content">
                <div class="alert alert-info">
                    <strong>Member Portal:</strong> Search for your house number to view your maintenance details.
                </div>

                <div class="setup-section">
                    <h3>üîç Find Your House</h3>
                    <div class="form-group">
                        <label>Enter House Number:</label>
                        <input type="text" id="searchHouse" placeholder="e.g., 101, 102, 103...">
                    </div>
                    <button class="btn btn-primary" onclick="searchMember()">üîç Search</button>
                </div>

                <div id="memberDetails" style="display: none;">
                    <div class="member-card">
                        <h4>House #<span id="memberHouseNum"></span></h4>
                        <p><strong>Owner:</strong> <span id="memberOwner"></span></p>
                        <p><strong>Status:</strong> <span id="memberStatus"></span></p>
                        <p><strong>Contact:</strong> <span id="memberContact"></span></p>
                        
                        <hr style="margin: 20px 0;">
                        
                        <h4>Monthly Charges Breakdown</h4>
                        <div id="chargesBreakdown"></div>
                        
                        <hr style="margin: 20px 0;">
                        
                        <h4>Payment Summary</h4>
                        <p><strong>Monthly Due:</strong> ‚Çπ<span id="memberMonthlyDue"></span></p>
                        <p><strong>Total Paid:</strong> ‚Çπ<span id="memberTotalPaid"></span></p>
                        <p><strong>Balance:</strong> <span id="memberBalance"></span></p>
                        
                        <hr style="margin: 20px 0;">
                        
                        <h4>Payment History</h4>
                        <div id="paymentHistory"></div>
                    </div>
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="reports" class="tab-content">
                <div class="alert alert-success">
                    <strong>Reports & Analytics:</strong> Download various reports and view analytics.
                </div>

                <div class="setup-section">
                    <h3>üìä Available Reports</h3>
                    <div class="grid-2">
                        <button class="btn btn-primary" onclick="generateDefaultersList()">üìã Defaulters List</button>
                        <button class="btn btn-primary" onclick="generateMonthlyReport()">üìÖ Monthly Collection Report</button>
                        <button class="btn btn-primary" onclick="generateChargesSummary()">üí∞ Charges Summary</button>
                        <button class="btn btn-success" onclick="exportAllData()">üì• Export All Data</button>
                    </div>
                </div>

                <div id="reportOutput" class="setup-section" style="display: none;">
                    <h3>Report Output</h3>
                    <div id="reportContent"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration - REPLACE WITH YOUR WEB APP URL
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwrc2c_oZpabJh9UhupoYpwkQrXbMcrfJRj41aoGRiXAWMRKD5CuEWvwjApmPd3qh7ZoQ/exec';
        
        // Configuration
        let config = {
            apiKey: '',
            spreadsheetId: '',
            webAppUrl: WEB_APP_URL
        };
        
        // API Helper Functions
        async function apiCall(action, params = {}, method = 'GET') {
            if (!WEB_APP_URL || WEB_APP_URL.includes('PASTE_YOUR')) {
                console.error('Web App URL not configured');
                alert('‚ö†Ô∏è Please configure your Google Apps Script Web App URL first!');
                return null;
            }
            
            try {
                const url = new URL(WEB_APP_URL);
                url.searchParams.append('action', action);
                
                if (method === 'GET') {
                    Object.keys(params).forEach(key => {
                        url.searchParams.append(key, params[key]);
                    });
                    
                    const response = await fetch(url);
                    return await response.json();
                } else {
                    const formData = new FormData();
                    formData.append('action', action);
                    Object.keys(params).forEach(key => {
                        formData.append(key, params[key]);
                    });
                    
                    const response = await fetch(WEB_APP_URL, {
                        method: 'POST',
                        body: formData
                    });
                    return await response.json();
                }
            } catch (error) {
                console.error('API Error:', error);
                alert('Error connecting to server. Please check your internet connection.');
                return null;
            }
        }

        // Load config from localStorage
        function loadConfig() {
            const saved = localStorage.getItem('apartmentConfig');
            if (saved) {
                config = JSON.parse(saved);
                document.getElementById('apiKey').value = config.apiKey || '';
                document.getElementById('spreadsheetId').value = config.spreadsheetId || '';
            }
        }

        // Save configuration
        function saveConfig() {
            config.apiKey = document.getElementById('apiKey').value;
            config.spreadsheetId = document.getElementById('spreadsheetId').value;
            
            if (!config.apiKey || !config.spreadsheetId) {
                alert('Please enter both API Key and Spreadsheet ID');
                return;
            }
            
            localStorage.setItem('apartmentConfig', JSON.stringify(config));
            alert('‚úÖ Configuration saved successfully!');
        }

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // Initialize members
        async function initializeMembers() {
            if (!WEB_APP_URL || WEB_APP_URL.includes('PASTE_YOUR')) {
                alert('‚ö†Ô∏è Please configure your Google Apps Script Web App URL first in the code!');
                return;
            }

            const occupied = parseInt(document.getElementById('occupiedHouses').value);
            const interior = parseInt(document.getElementById('interiorHouses').value);

            if (confirm(`This will create 53 house records with ${occupied} occupied and ${interior} interior ongoing. Continue?`)) {
                const result = await apiCall('initializeMembers', {
                    occupiedCount: occupied,
                    interiorCount: interior
                }, 'POST');
                
                if (result && result.success) {
                    alert('‚úÖ ' + result.message);
                    // Save config
                    localStorage.setItem('occupiedHouses', occupied);
                    localStorage.setItem('interiorHouses', interior);
                } else {
                    alert('‚ùå Failed to initialize members. Please check console for errors.');
                }
            }
        }

        // Save monthly charges
        function saveMonthlyCharges() {
            const charges = {
                meterCharges: parseFloat(document.getElementById('meterCharges').value),
                sanitaryCharges: parseFloat(document.getElementById('sanitaryCharges').value),
                otherCharges: parseFloat(document.getElementById('otherCharges').value),
                borewellCharges: parseFloat(document.getElementById('borewellCharges').value),
                securitySalary: parseFloat(document.getElementById('securitySalary').value),
                commonPower: parseFloat(document.getElementById('commonPower').value),
                waterCharges: parseFloat(document.getElementById('waterCharges').value),
                dieselCharges: parseFloat(document.getElementById('dieselCharges').value)
            };

            localStorage.setItem('monthlyCharges', JSON.stringify(charges));
            alert('‚úÖ Monthly charges saved!');
        }

        // Calculate monthly due for a member
        function calculateMonthlyDue(status) {
            const charges = JSON.parse(localStorage.getItem('monthlyCharges') || '{}');
            const occupied = parseInt(document.getElementById('occupiedHouses').value) || 12;
            const interior = parseInt(document.getElementById('interiorHouses').value) || 0;
            
            // Fixed charges divided by 53
            let total = (
                (charges.meterCharges || 0) / 53 +
                (charges.sanitaryCharges || 0) / 53 +
                (charges.otherCharges || 0) / 53 +
                (charges.borewellCharges || 0) / 53 +
                (charges.securitySalary || 0) / 53 +
                (charges.commonPower || 0) / 53
            );

            // Water charges - only for occupied and interior ongoing
            if (status === 'Occupied' || status === 'Interior Ongoing') {
                total += (charges.waterCharges || 0) / (occupied + interior);
                
                // Diesel - 70% for occupied/interior, 30% for others
                total += ((charges.dieselCharges || 0) * 0.7) / (occupied + interior);
            } else {
                total += ((charges.dieselCharges || 0) * 0.3) / (53 - occupied - interior);
            }

            return Math.round(total);
        }

        // Record payment
        async function recordPayment() {
            const house = document.getElementById('paymentHouse').value;
            const amount = document.getElementById('paymentAmount').value;
            const date = document.getElementById('paymentDate').value;
            const mode = document.getElementById('paymentMode').value;
            const notes = document.getElementById('paymentNotes').value;

            if (!house || !amount || !date) {
                alert('Please fill all required fields!');
                return;
            }

            const result = await apiCall('recordPayment', {
                houseNumber: house,
                amount: amount,
                date: date,
                mode: mode,
                notes: notes
            }, 'POST');
            
            if (result && result.success) {
                alert('‚úÖ Payment recorded successfully! Payment ID: ' + result.paymentId);
                
                // Clear form
                document.getElementById('paymentAmount').value = '';
                document.getElementById('paymentNotes').value = '';
                
                // Refresh member list
                loadAllMembers();
            } else {
                alert('‚ùå Failed to record payment. Please try again.');
            }
        }

        // Load all members for admin
        async function loadAllMembers() {
            const tbody = document.getElementById('adminMembersBody');
            tbody.innerHTML = '<tr><td colspan="7" class="loading"><div class="spinner"></div>Loading data...</td></tr>';
            
            const members = await apiCall('getAllMembers');
            
            if (!members || members.error) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color: #dc3545;">Failed to load data. Please check your configuration.</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            
            members.forEach(member => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${member.houseNumber}</td>
                    <td>${member.ownerName}</td>
                    <td>${member.status}</td>
                    <td>‚Çπ${member.monthlyDue.toLocaleString('en-IN')}</td>
                    <td>‚Çπ${member.totalPaid.toLocaleString('en-IN')}</td>
                    <td>‚Çπ${member.balance.toLocaleString('en-IN')}</td>
                    <td class="${member.balance > 0 ? 'status-pending' : 'status-paid'}">
                        ${member.balance > 0 ? 'Pending' : 'Paid'}
                    </td>
                `;
            });

            // Populate house dropdown
            const select = document.getElementById('paymentHouse');
            select.innerHTML = '<option value="">Select House</option>';
            members.forEach(member => {
                select.innerHTML += `<option value="${member.houseNumber}">${member.houseNumber} - ${member.ownerName}</option>`;
            });
            
            // Update stats
            updateStats(members);
        }
        
        // Update statistics
        function updateStats(members) {
            const totalHouses = members.length;
            const totalCollected = members.reduce((sum, m) => sum + m.totalPaid, 0);
            const totalPending = members.reduce((sum, m) => sum + m.balance, 0);
            const totalDue = members.reduce((sum, m) => sum + m.monthlyDue, 0);
            const collectionRate = totalDue > 0 ? ((totalCollected / totalDue) * 100).toFixed(1) : 0;
            
            document.getElementById('totalHouses').textContent = totalHouses;
            document.getElementById('totalCollected').textContent = '‚Çπ' + totalCollected.toLocaleString('en-IN');
            document.getElementById('totalPending').textContent = '‚Çπ' + totalPending.toLocaleString('en-IN');
            document.getElementById('collectionRate').textContent = collectionRate + '%';
        }

        // Search member
        async function searchMember() {
            const houseNum = document.getElementById('searchHouse').value.toUpperCase().trim();
            
            if (!houseNum) {
                alert('Please enter a house number!');
                return;
            }

            // Show loading
            document.getElementById('memberDetails').style.display = 'block';
            document.getElementById('chargesBreakdown').innerHTML = '<div class="loading"><div class="spinner"></div>Loading...</div>';
            
            const data = await apiCall('getMember', { houseNumber: houseNum });
            
            if (!data || data.error) {
                alert('Member not found or error occurred!');
                document.getElementById('memberDetails').style.display = 'none';
                return;
            }
            
            const member = data.member;
            const payments = data.payments;
            
            // Display member info
            document.getElementById('memberHouseNum').textContent = member.houseNumber;
            document.getElementById('memberOwner').textContent = member.ownerName;
            document.getElementById('memberStatus').textContent = member.status;
            document.getElementById('memberContact').textContent = member.contact || 'Not provided';
            document.getElementById('memberMonthlyDue').textContent = member.monthlyDue.toLocaleString('en-IN');
            document.getElementById('memberTotalPaid').textContent = member.totalPaid.toLocaleString('en-IN');
            
            const balanceText = member.balance > 0 
                ? `‚Çπ${member.balance.toLocaleString('en-IN')} (Pending)` 
                : '‚Çπ0 (Fully Paid)';
            document.getElementById('memberBalance').innerHTML = `<span class="${member.balance > 0 ? 'status-pending' : 'status-paid'}">${balanceText}</span>`;
            
            // Show charges breakdown
            const charges = await apiCall('getCharges');
            let breakdown = '<table style="width:100%; font-size: 14px;">';
            breakdown += '<tr><th style="text-align:left;">Charge Type</th><th style="text-align:right;">Amount</th></tr>';
            
            if (charges && charges.length > 0) {
                charges.forEach(charge => {
                    let perHouse = 0;
                    if (charge.splitType === 'All 53') {
                        perHouse = charge.amount / 53;
                    } else if (charge.splitType === 'Occupied+Interior') {
                        const occupied = parseInt(localStorage.getItem('occupiedHouses') || 12);
                        const interior = parseInt(localStorage.getItem('interiorHouses') || 0);
                        if (member.status === 'Occupied' || member.status === 'Interior Ongoing') {
                            perHouse = charge.amount / (occupied + interior);
                        }
                    } else if (charge.splitType === 'Special') {
                        // Diesel special calculation
                        const occupied = parseInt(localStorage.getItem('occupiedHouses') || 12);
                        const interior = parseInt(localStorage.getItem('interiorHouses') || 0);
                        if (member.status === 'Occupied' || member.status === 'Interior Ongoing') {
                            perHouse = (charge.amount * 0.7) / (occupied + interior);
                        } else {
                            perHouse = (charge.amount * 0.3) / (53 - occupied - interior);
                        }
                    }
                    
                    if (perHouse > 0) {
                        breakdown += `<tr><td>${charge.chargeType}</td><td style="text-align:right;">‚Çπ${Math.round(perHouse)}</td></tr>`;
                    }
                });
            }
            
            breakdown += `<tr style="font-weight:bold; border-top: 2px solid #333;"><td>Total</td><td style="text-align:right;">‚Çπ${member.monthlyDue}</td></tr>`;
            breakdown += '</table>';
            
            document.getElementById('chargesBreakdown').innerHTML = breakdown;
            
            // Payment history
            let historyHTML = '';
            if (payments && payments.length > 0) {
                payments.forEach(payment => {
                    historyHTML += `
                        <div class="payment-record">
                            <div>
                                <strong>${payment.notes || 'Payment'}</strong><br>
                                <small>Date: ${new Date(payment.date).toLocaleDateString('en-IN')} | Mode: ${payment.mode}</small>
                            </div>
                            <div style="text-align: right;">
                                <strong style="color: #28a745;">‚Çπ${payment.amount.toLocaleString('en-IN')}</strong>
                            </div>
                        </div>
                    `;
                });
            } else {
                historyHTML = '<p style="color: #999;">No payment history available</p>';
            }
            
            document.getElementById('paymentHistory').innerHTML = historyHTML;
        }

        // Export functions
        function exportToExcel() {
            alert('Export feature will download all member data as Excel file');
        }

        function generateDefaultersList() {
            alert('This will generate a list of members with pending payments');
        }

        function generateMonthlyReport() {
            alert('This will generate monthly collection summary');
        }

        function generateChargesSummary() {
            alert('This will generate detailed charges breakdown');
        }

        function exportAllData() {
            alert('This will export complete database to Excel');
        }

        // Set today's date as default
        document.getElementById('paymentDate').valueAsDate = new Date();

        // Load config on page load
        loadConfig();
    </script>
</body>
</html>
